<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">

	<!-- 게시판 리스트 가져오기 -->
	<select id="listCriteria" resultType="BoardVo">
		SELECT
		board_no as boardNo,
		board_id as boardId,
		board_pw as boardPw,
		board_title as boardTitle,
		board_content as boardContent,
		board_hit as boardHit,
		board_Del_Flag as
		boardDelFlag,
		board_reg_dt as boardRegDate,
		board_udt_dt as
		boardUdtDate,
		board_del_dt as boardDelDate
		FROM tb_board
		where board_no >
		0 AND board_Del_flag = 'Y'
		ORDER BY
		board_no DESC
		LIMIT #{pageStart},
		#{perPageNum}
	</select>


	<!-- 게시판 리스트 전체 갯수 가져오기 -->
	<select id="countboards" resultType="int">
    <![CDATA[
    SELECT
        COUNT(board_no)
    FROM tb_board
    WHERE board_no > 0 AND board_Del_flag = 'Y'
    ]]>
	</select>


	<!-- 게시글 생성 -->
	<insert id="insertBoard">
		INSERT INTO tb_board (
		board_no,
		board_id ,
		board_pw ,
		board_title ,
		board_content,
		board_file_Id
		) VALUES (
		(select
		max(o.board_no)+1 from
		tb_board o),
		#{boardId} ,
		#{boardId} ,
		#{boardTitle} ,
		#{boardContent},
		#{boardFileId}
		)

	</insert>
	
	<!-- 게시글 읽기 -->
	<select id="insertBoardRead" resultType="BoardVo">
		SELECT
		board_no as
		boardNo,
		board_id as boardId,
		board_pw as boardPw,
		board_title as
		boardTitle,
		board_content as boardContent,
		board_hit as boardHit,
		board_Del_flag as boardDelflag,
		board_reg_dt as boardRegDate,
		board_udt_dt as boardUdtDate,
		board_del_dt as boardDelDate,
		board_file_id as boardFileId
		FROM tb_board
		WHERE board_no = #{no}

	</select>

	<!-- 게시글 수정 -->
	<update id="updateBoard">
		UPDATE tb_board
		SET
		board_title = #{boardTitle}
		,board_content = #{boardContent}
		,board_udt_dt = NOW()
		,board_file_id =
		#{boardFileId}
		WHERE
		board_no = #{boardNo}
	</update>
	
	<!-- 게시글 삭제 -->
	<update id="deleteBoard">
		UPDATE tb_board
		SET
		board_del_flag = 'N',
		board_del_dt = NOW()
		WHERE
		board_no = #{boardNo}
	</update>
	
	<!-- search -->
	<select id="listSearch" resultType="BoardVo">

		SELECT
		board_no as boardNo,
		board_id as boardId,
		board_pw as boardPw,
		board_title as boardTitle,
		board_content as boardContent,
		board_hit as
		boardHit,
		board_Del_Flag as
		boardDelFlag,
		board_reg_dt as boardRegDate,
		board_udt_dt as
		boardUdtDate,
		board_del_dt as boardDelDate
		FROM tb_board
		where board_no >
		0 AND board_Del_flag = 'Y'

		<include refid="search" />
		ORDER BY
		board_no DESC
		LIMIT #{pageStart},
		#{perPageNum}
	</select>

	<select id="countSearchedboards" resultType="int">
		SELECT
		COUNT(board_no)
		FROM tb_board
		WHERE board_no > 0
		AND board_Del_flag
		= 'Y'
		<include refid="search" />
	</select>


	<sql id="search">
		<if test="searchType != null">
			<if test="searchType == 't'.toString()">
				AND board_title LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType == 'c'.toString()">
				AND board_content LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType == 'w'.toString()">
				AND board_id LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType == 'tc'.toString()">
				AND (
				board_title LIKE CONCAT('%', #{keyword}, '%')
				OR
				board_content LIKE CONCAT('%', #{keyword}, '%')
				)
			</if>
			<if test="searchType == 'cw'.toString()">
				AND (
				board_content LIKE CONCAT('%', #{keyword}, '%')
				OR
				board_id LIKE CONCAT('%', #{keyword}, '%')
				)
			</if>
			<if test="searchType == 'tcw'.toString()">
				AND (
				board_title LIKE CONCAT('%', #{keyword}, '%')
				OR
				board_content LIKE CONCAT('%', #{keyword}, '%')
				OR board_id LIKE
				CONCAT('%', #{keyword}, '%')
				)
			</if>
		</if>
	</sql>
	
	<!-- 조회수 카운트 -->
	<update id="updateViewCnt">
		UPDATE tb_board
		SET board_hit = board_hit + 1
		WHERE
		board_no = #{boardNo}
		AND board_Del_flag = 'Y'
	</update>
	
	<!-- 파일 관련 sql -->
		
	<!-- 파일 생성 -->
	<insert id="insertFile">

		INSERT INTO tb_file (
		file_no,
		file_id,
		file_name ,
		file_original_name,
		file_path ,
		file_type ,
		file_size
		)
		VALUES (
		(select
		max(z.file_no)+1 from tb_file z),
		#{fileName},
		#{fileName},
		#{fileOrginalName},
		#{filePath},
		#{fileType},
		#{fileSize}
		)
	</insert>

	<!-- 게시글 파일 가져오기 -->
	<select id="selectFileList" resultMap="fileResultMap">
		SELECT
		file_no,
		file_id,
		file_name,
		file_original_name,
		file_path,
		file_type,
		file_size,
		file_del_flag,
		file_reg_dt,
		file_del_dt		
		FROM tb_file
		WHERE file_id = (select o.board_file_id from tb_board o where board_no=#{boardNo})
		AND
		file_del_flag = 'Y'		

	</select>

	<resultMap id="boardResultMap" type="BoardVo">
		<id property="boardNo" column="board_no" />
		<result property="boardId" column="board_id" />
		<result property="boardPw" column="board_pw" />
		<result property="boardTitle" column="board_title" />
		<result property="boardContent" column="board_content" />
		<result property="boardHit" column="board_hit" />
		<result property="boardLookPost" column="board_look_post" />
		<result property="boardDelFlag" column="board_delete_flag" />
		<result property="boardRegDate" column="board_reg_dt" />
		<result property="boardUdtDate" column="board_udt_dt" />
		<result property="boardDelDate" column="board_del_dt" />
	</resultMap>
	
	<resultMap id="fileResultMap" type="FileVo">
		<id property="fileNo" column="file_no" />
		<result property="fileId" column="file_id" />
		<result property="fileName" column="file_name" />
		<result property="fileOrginalName" column="file_original_name" />
		<result property="filePath" column="file_path" />
		<result property="fileType" column="file_type" />
		<result property="fileSize" column="file_size" />
		<result property="fileDelFlag" column="file_del_flag" />
		<result property="fileRegDate" column="file_reg_dt" />
		<result property="fileDelDate" column="file_del_dt" />		
	</resultMap>
	
	



</mapper>